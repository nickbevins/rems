{% extends "base.html" %}

{% block title %}Compliance Dashboard - REMS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-check-circle"></i> Compliance Dashboard</h1>
            <div>
                <a href="{{ url_for('export_compliance') }}" class="btn btn-success">
                    <i class="fas fa-download"></i> Export CSV
                </a>
                {% if current_user.can_manage_compliance() %}
                    <a href="{{ url_for('import_compliance') }}" class="btn btn-info">
                        <i class="fas fa-file-import"></i> Import CSV
                    </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" id="filterForm" class="row g-3">
                    <!-- Preserve days parameter -->
                    <input type="hidden" name="days" value="{{ days_ahead }}">
                    
                    <!-- First row: Dropdown filters -->
                    <div class="col-md-3">
                        <label for="eq_class" class="form-label">Equipment Class</label>
                        <select name="eq_class" id="eq_class" class="form-select auto-filter">
                            <option value="">All Classes</option>
                            {% for class_name in classes %}
                                <option value="{{ class_name }}" {% if eq_class == class_name %}selected{% endif %}>
                                    {{ class_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="eq_subclass" class="form-label">Subclass</label>
                        <select name="eq_subclass" id="eq_subclass" class="form-select auto-filter">
                            <option value="">All Subclasses</option>
                            {% for subclass in subclasses %}
                                <option value="{{ subclass }}" {% if eq_subclass == subclass %}selected{% endif %}>
                                    {{ subclass }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="eq_fac" class="form-label">Facility</label>
                        <select name="eq_fac" id="eq_fac" class="form-select auto-filter">
                            <option value="">All Facilities</option>
                            {% for facility in facilities %}
                                <option value="{{ facility }}" {% if eq_fac == facility %}selected{% endif %}>
                                    {{ facility }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" name="search" id="search" class="form-control" 
                               placeholder="Search equipment..." 
                               value="{{ search }}">
                    </div>
                </form>
                
                <!-- Clear button and results count -->
                <div class="row mt-2">
                    <div class="col-6">
                        <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted">
                            Showing {{ overdue_tests|length + upcoming_tests|length + scheduled_tests|length }} total compliance items
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">Overdue Tests</h5>
                                <h2>{{ overdue_tests|length }}</h2>
                                <p class="mb-0">Require immediate attention</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">Upcoming Tests</h5>
                                <h2>{{ upcoming_tests|length }}</h2>
                                <p class="mb-0">Due within {{ days_ahead }} days</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white" style="background-color: #0066cc;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">Scheduled Tests</h5>
                                <h2>{{ scheduled_tests|length }}</h2>
                                <p class="mb-0">Future test dates</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar-alt fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Overdue Tests -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-exclamation-triangle"></i> Overdue Tests - Immediate Action Required</h5>
            </div>
            <div class="card-body">
                {% if overdue_tests %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="overdueTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="equipment" style="width: 23%;">Equipment <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="facility" style="width: 11%;">Facility <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="department" style="width: 14%;">Department <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="room" style="width: 9%;">Room <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="last_tested" style="width: 11%;">Last Tested <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="due_date" style="width: 11%;">Due Date <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="days_overdue" style="width: 11%;">Days Overdue <i class="fas fa-sort"></i></th>
                                    <th style="width: 15%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test, equipment in overdue_tests %}
                                <tr data-equipment="{{ equipment.eq_class }} {{ equipment.eq_manu }} {{ equipment.eq_mod }}" 
                                    data-equipment-id="{{ equipment.eq_id }}" 
                                    data-facility="{{ equipment.eq_fac or '' }}" 
                                    data-department="{{ equipment.eq_dept or '' }}" 
                                    data-room="{{ equipment.eq_rm or '' }}" 
                                    data-last-tested="{{ test.last_tested_date.strftime('%Y-%m-%d') if test.last_tested_date else '' }}" 
                                    data-due-date="{{ test.next_due_date.strftime('%Y-%m-%d') }}" 
                                    data-days-overdue="{{ (today - test.next_due_date).days }}">
                                    <td>
                                        <div class="fw-bold">{{ equipment.equipment_class.name if equipment.equipment_class else equipment.eq_class }}</div>
                                        <div class="text-muted">{{ equipment.manufacturer.name if equipment.manufacturer else equipment.eq_manu }} {{ equipment.eq_mod }}</div>
                                    </td>
                                    <td>{{ equipment.facility.name if equipment.facility else 'N/A' }}</td>
                                    <td>{{ equipment.department.name if equipment.department else 'N/A' }}</td>
                                    <td>{{ equipment.eq_rm or 'N/A' }}</td>
                                    <td>{{ test.last_tested_date.strftime('%Y-%m-%d') if test.last_tested_date else 'N/A' }}</td>
                                    <td>{{ test.next_due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% set days_overdue = (today - test.next_due_date).days %}
                                        <span class="badge bg-danger">{{ days_overdue }} days</span>
                                    </td>
                                    <td>
                                        {% if current_user.can_manage_compliance() %}
                                            <a href="{{ url_for('compliance_test_new', eq_id=equipment.eq_id, redirect_to='compliance') }}" 
                                               class="btn btn-sm btn-warning text-nowrap">
                                                <i class="fas fa-plus"></i> Add Test
                                            </a>
                                        {% else %}
                                            <span class="text-muted">View Only</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success"></i>
                        <h4 class="text-success mt-3">No overdue tests!</h4>
                        <p class="text-muted">All compliance tests are up to date.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Upcoming Tests -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="text-dark mb-0"><i class="fas fa-clock"></i> Upcoming Tests ({{ upcoming_tests|length }} within {{ days_ahead }} days)</h5>
                    <div class="d-flex align-items-center">
                        <label for="daysAheadFilter" class="form-label me-2 mb-0 text-dark">Due within:</label>
                        <select id="daysAheadFilter" class="form-select form-select-sm" style="width: auto;">
                            <option value="30" {% if days_ahead == 30 %}selected{% endif %}>30 days</option>
                            <option value="60" {% if days_ahead == 60 %}selected{% endif %}>60 days</option>
                            <option value="90" {% if days_ahead == 90 %}selected{% endif %}>90 days</option>
                            <option value="120" {% if days_ahead == 120 %}selected{% endif %}>120 days</option>
                            <option value="180" {% if days_ahead == 180 %}selected{% endif %}>180 days</option>
                            <option value="365" {% if days_ahead == 365 %}selected{% endif %}>1 year</option>
                            <option value="custom" {% if days_ahead not in [30, 60, 90, 120, 180, 365] %}selected{% endif %}>Custom...</option>
                        </select>
                        <input type="number" id="customDaysInput" class="form-control form-control-sm ms-2" 
                               style="width: 80px; {% if days_ahead not in [30, 60, 90, 120, 180, 365] %}display: inline-block;{% else %}display: none;{% endif %}" 
                               placeholder="Days" min="1" max="9999" 
                               value="{% if days_ahead not in [30, 60, 90, 120, 180, 365] %}{{ days_ahead }}{% endif %}">
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if upcoming_tests %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="upcomingTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="equipment" style="width: 23%;">Equipment <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="facility" style="width: 11%;">Facility <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="department" style="width: 14%;">Department <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="room" style="width: 9%;">Room <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="last_tested" style="width: 11%;">Last Tested <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="due_date" style="width: 11%;">Due Date <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="days_until" style="width: 11%;">Days Until Due <i class="fas fa-sort"></i></th>
                                    <th style="width: 15%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test, equipment in upcoming_tests %}
                                {% set days_until = (test.next_due_date - today).days %}
                                <tr data-equipment="{{ equipment.eq_class }} {{ equipment.eq_manu }} {{ equipment.eq_mod }}" 
                                    data-equipment-id="{{ equipment.eq_id }}" 
                                    data-facility="{{ equipment.eq_fac or '' }}" 
                                    data-department="{{ equipment.eq_dept or '' }}" 
                                    data-room="{{ equipment.eq_rm or '' }}" 
                                    data-last-tested="{{ test.last_tested_date.strftime('%Y-%m-%d') if test.last_tested_date else '' }}" 
                                    data-due-date="{{ test.next_due_date.strftime('%Y-%m-%d') }}" 
                                    data-days-until="{{ days_until }}">
                                    <td>
                                        <div class="fw-bold">{{ equipment.equipment_class.name if equipment.equipment_class else equipment.eq_class }}</div>
                                        <div class="text-muted">{{ equipment.manufacturer.name if equipment.manufacturer else equipment.eq_manu }} {{ equipment.eq_mod }}</div>
                                    </td>
                                    <td>{{ equipment.facility.name if equipment.facility else 'N/A' }}</td>
                                    <td>{{ equipment.department.name if equipment.department else 'N/A' }}</td>
                                    <td>{{ equipment.eq_rm or 'N/A' }}</td>
                                    <td>{{ test.last_tested_date.strftime('%Y-%m-%d') if test.last_tested_date else 'N/A' }}</td>
                                    <td>{{ test.next_due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if days_until <= 7 %}
                                            <span class="badge bg-danger">{{ days_until }} days</span>
                                        {% elif days_until <= 30 %}
                                            <span class="badge bg-warning text-dark">{{ days_until }} days</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ days_until }} days</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if current_user.can_manage_compliance() %}
                                            <div class="d-flex flex-column gap-1">
                                                <a href="{{ url_for('compliance_test_new', eq_id=equipment.eq_id, redirect_to='compliance') }}"
                                                   class="btn btn-sm btn-warning text-nowrap">
                                                    <i class="fas fa-plus"></i> Add Test
                                                </a>
                                                <a href="{{ url_for('schedule_test_new', eq_id=equipment.eq_id, redirect_to='compliance') }}"
                                                   class="btn btn-sm btn-success text-nowrap">
                                                    <i class="fas fa-calendar-plus"></i> Schedule
                                                </a>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">View Only</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-check fa-3x text-muted"></i>
                        <h4 class="text-muted mt-3">No upcoming tests</h4>
                        <p class="text-muted">No tests are due within the next {{ days_ahead }} days.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Scheduled Tests -->
        <div class="card">
            <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #0066cc;">
                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Scheduled Tests</h5>
                {% if current_user.can_manage_compliance() %}
                <div>
                    <a href="{{ url_for('export_scheduled_tests') }}" class="btn btn-sm btn-light">
                        <i class="fas fa-download"></i> Export CSV
                    </a>
                    <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#importScheduledTestsModal">
                        <i class="fas fa-upload"></i> Import CSV
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if scheduled_tests %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="scheduledTable" style="table-layout: fixed; width: 100%;">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="equipment" style="width: 18%;">Equipment <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="facility" style="width: 12%;">Facility <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="department" style="width: 12%;">Department <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="room" style="width: 10%;">Room <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="scheduled_date" style="width: 13%;">Scheduled Date <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="scheduling_date" style="width: 13%;">Scheduling Date <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="created_by" style="width: 12%;">Created By <i class="fas fa-sort"></i></th>
                                    <th style="width: 10%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test, equipment in scheduled_tests %}
                                <tr data-equipment="{{ equipment.equipment_class.name if equipment.equipment_class else '' }} {{ equipment.manufacturer.name if equipment.manufacturer else '' }} {{ equipment.eq_mod }}"
                                    data-equipment-id="{{ equipment.eq_id }}"
                                    data-facility="{{ equipment.facility.name if equipment.facility else '' }}"
                                    data-department="{{ equipment.department.name if equipment.department else '' }}"
                                    data-room="{{ equipment.eq_rm or '' }}"
                                    data-scheduled-date="{{ test.scheduled_date.strftime('%Y-%m-%d') }}"
                                    data-scheduling-date="{{ test.scheduling_date.strftime('%Y-%m-%d') }}"
                                    data-created-by="{{ test.created_by.name if test.created_by else '' }}">
                                    <td>
                                        <div class="fw-bold">{{ equipment.equipment_class.name if equipment.equipment_class else 'N/A' }}</div>
                                        <div class="text-muted">{{ equipment.manufacturer.name if equipment.manufacturer else '' }} {{ equipment.eq_mod }}</div>
                                    </td>
                                    <td>{{ equipment.facility.name if equipment.facility else 'N/A' }}</td>
                                    <td>{{ equipment.department.name if equipment.department else 'N/A' }}</td>
                                    <td>{{ equipment.eq_rm or 'N/A' }}</td>
                                    <td>{{ test.scheduled_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ test.scheduling_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if test.created_by %}
                                            <span class="badge bg-secondary" title="Created: {{ test.created_at.strftime('%Y-%m-%d %H:%M') if test.created_at else 'Unknown' }}">{{ test.created_by.name }}</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if current_user.can_manage_compliance() %}
                                            <a href="{{ url_for('schedule_test_edit', schedule_id=test.schedule_id, redirect_to='compliance') }}"
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                        {% else %}
                                            <span class="text-muted">View Only</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-alt fa-3x text-muted"></i>
                        <h4 class="text-muted mt-3">No scheduled tests</h4>
                        <p class="text-muted">No tests are currently scheduled.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Import Scheduled Tests Modal -->
        <div class="modal fade" id="importScheduledTestsModal" tabindex="-1" aria-labelledby="importScheduledTestsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="importScheduledTestsModalLabel">Import Scheduled Tests</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="POST" action="{{ url_for('import_scheduled_tests') }}" enctype="multipart/form-data">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="file" class="form-label">CSV File</label>
                                <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                                <div class="form-text">Upload a CSV file with scheduled test data</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Import</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sortable {
    cursor: pointer;
    user-select: none;
}
.sortable:hover {
    background-color: rgba(0, 0, 0, 0.1);
}
.sortable i {
    margin-left: 5px;
    opacity: 0.3;
}
.sortable.asc i:before {
    content: "\f0de";
    opacity: 1;
}
.sortable.desc i:before {
    content: "\f0dd";
    opacity: 1;
}

/* Bootstrap table-hover handles row hover effects automatically */
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-filter functionality
    const autoFilterElements = document.querySelectorAll('.auto-filter');
    const searchInput = document.getElementById('search');
    
    autoFilterElements.forEach(element => {
        element.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    });
    
    // Handle search input with Enter key
    if (searchInput) {
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('filterForm').submit();
            }
        });
    }
    
    // Cascading filter: Update subclasses when class changes
    const classSelect = document.getElementById('eq_class');
    const subclassSelect = document.getElementById('eq_subclass');
    const currentSubclass = '{{ eq_subclass }}';
    
    function updateSubclasses() {
        const selectedClass = classSelect.value;
        const url = selectedClass ? '/api/subclasses?eq_class=' + encodeURIComponent(selectedClass) : '/api/subclasses';
        
        fetch(url)
            .then(response => response.json())
            .then(subclasses => {
                // Clear existing options
                subclassSelect.innerHTML = '<option value="">All Subclasses</option>';
                
                // Add new options
                subclasses.forEach(subclass => {
                    const option = document.createElement('option');
                    option.value = subclass;
                    option.textContent = subclass;
                    
                    // Maintain selection if it's still valid
                    if (subclass === currentSubclass) {
                        option.selected = true;
                    }
                    
                    subclassSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading subclasses:', error);
            });
    }
    
    // Update subclasses when class changes
    if (classSelect && subclassSelect) {
        classSelect.addEventListener('change', function() {
            updateSubclasses();
            // Clear subclass selection when class changes
            subclassSelect.value = '';
        });
        
        // Initial load - update subclasses for current class selection
        if (classSelect.value) {
            updateSubclasses();
        }
    }
    // Add sorting functionality to all tables
    const tables = ['overdueTable', 'upcomingTable', 'scheduledTable'];
    
    tables.forEach(tableId => {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const sortableHeaders = table.querySelectorAll('.sortable');
        let currentSort = { column: '', direction: 'asc', table: tableId };
        
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const column = this.dataset.column;
                let direction = 'asc';
                
                // Toggle direction if clicking the same column
                if (currentSort.column === column && currentSort.table === tableId) {
                    direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                }
                
                currentSort = { column, direction, table: tableId };
                sortTable(tableId, column, direction);
                updateSortIcons(table, this, direction);
            });
        });
    });
    
    function sortTable(tableId, column, direction) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            // Convert snake_case to camelCase for dataset API
            const datasetKey = column.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase());
            let aValue = a.dataset[datasetKey] || '';
            let bValue = b.dataset[datasetKey] || '';
            
            // Handle numeric sorting for days
            if (column.includes('days') || column === 'days_overdue' || column === 'days_until') {
                aValue = parseInt(aValue) || 0;
                bValue = parseInt(bValue) || 0;
            }
            // Handle date sorting
            else if (column.includes('date') || column === 'last_tested') {
                aValue = new Date(aValue || '1900-01-01');
                bValue = new Date(bValue || '1900-01-01');
            }
            // Handle text sorting
            else {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }
            
            if (direction === 'asc') {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue < bValue ? 1 : -1;
            }
        });
        
        // Clear and re-append sorted rows
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function updateSortIcons(table, activeHeader, direction) {
        // Reset all icons in this table
        const allHeaders = table.querySelectorAll('.sortable');
        allHeaders.forEach(header => {
            const icon = header.querySelector('i');
            icon.className = 'fas fa-sort';
        });
        
        // Set active icon
        const activeIcon = activeHeader.querySelector('i');
        activeIcon.className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
    
    // Add double-click functionality to table rows
    tables.forEach(tableId => {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            row.style.cursor = 'pointer';
            row.addEventListener('dblclick', function() {
                const equipmentId = this.dataset.equipmentId;
                if (equipmentId) {
                    window.location.href = `/equipment/${equipmentId}`;
                }
            });
            
            // No custom hover effects needed - Bootstrap table-hover handles this
        });
    });
    
    // Handle upcoming tests filter
    const daysAheadFilter = document.getElementById('daysAheadFilter');
    const customDaysInput = document.getElementById('customDaysInput');
    
    if (daysAheadFilter) {
        daysAheadFilter.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDaysInput.style.display = 'inline-block';
                customDaysInput.focus();
            } else {
                customDaysInput.style.display = 'none';
                // Reload page with new days parameter
                const url = new URL(window.location);
                url.searchParams.set('days', this.value);
                window.location.href = url.toString();
            }
        });
        
        customDaysInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const days = parseInt(this.value);
                if (days && days > 0) {
                    // Reload page with custom days parameter
                    const url = new URL(window.location);
                    url.searchParams.set('days', days);
                    window.location.href = url.toString();
                }
            }
        });
        
        // Also handle blur event for when user clicks away from custom input
        customDaysInput.addEventListener('blur', function() {
            const days = parseInt(this.value);
            if (days && days > 0) {
                // Reload page with custom days parameter
                const url = new URL(window.location);
                url.searchParams.set('days', days);
                window.location.href = url.toString();
            }
        });
    }
});

// Clear all filters
function clearFilters() {
    const form = document.getElementById('filterForm');
    const inputs = form.querySelectorAll('input:not([type="hidden"]), select');
    
    inputs.forEach(input => {
        if (input.type !== 'hidden') {
            input.value = '';
        }
    });
    
    // Submit form to clear filters
    form.submit();
}
</script>
{% endblock %}