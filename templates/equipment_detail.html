{% extends "base.html" %}

{% block title %}{{ equipment.equipment_class.name if equipment.equipment_class else 'Equipment' }} - {{ equipment.manufacturer.name if equipment.manufacturer else 'Unknown' }} {{ equipment.eq_mod }} - REMS{% endblock %}

{% block content %}
{% set is_retired = equipment.eq_retired or (equipment.eq_retdate and equipment.eq_retdate <= today) %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-cog"></i> 
                {{ equipment.equipment_class.name if equipment.equipment_class else 'Equipment' }} 
                {% if is_retired %}
                    <span class="badge bg-danger">Retired</span>
                {% else %}
                    <span class="badge bg-success">Active</span>
                {% endif %}
            </h1>
            <div>
                {% if redirect_to == 'compliance' %}
                    <a href="{{ url_for('compliance_dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                {% else %}
                    <a href="{{ url_for('equipment_list', **search_params) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                {% endif %}
                {% if not is_retired and current_user.can_manage_compliance() %}
                    <a href="{{ url_for('compliance_test_new', eq_id=equipment.eq_id, **request.args) }}" class="btn btn-warning">
                        <i class="fas fa-plus"></i> Add Test
                    </a>
                {% endif %}
            </div>
        </div>
        
        <div class="row">
            <!-- Equipment Details -->
            <div class="col-md-8">
                <div class="card" id="equipment-details-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Equipment Details</h5>
                        {% if current_user.can_manage_equipment() %}
                            <button class="btn btn-sm btn-outline-primary edit-card-btn" data-card="equipment-details" title="Edit Equipment Details">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <th width="40%">Equipment ID:</th>
                                        <td>{{ equipment.eq_id }}</td>
                                    </tr>
                                    <tr>
                                        <th>Class:</th>
                                        <td>{{ equipment.equipment_class.name if equipment.equipment_class else 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Subclass:</th>
                                        <td>{{ equipment.equipment_subclass.name if equipment.equipment_subclass else 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Manufacturer:</th>
                                        <td>{{ equipment.manufacturer.name if equipment.manufacturer else 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Model:</th>
                                        <td>{{ equipment.eq_mod or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Facility:</th>
                                        <td>{{ equipment.facility.name if equipment.facility else 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Department:</th>
                                        <td>{{ equipment.department.name if equipment.department else 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Room:</th>
                                        <td>{{ equipment.eq_rm or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Phone:</th>
                                        <td>{{ equipment.eq_phone or 'N/A' }}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <th width="40%">Asset ID:</th>
                                        <td>{{ equipment.eq_assetid or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Serial Number:</th>
                                        <td>{{ equipment.eq_sn or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Manufacturer ID:</th>
                                        <td>{{ equipment.eq_manid or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Install Date:</th>
                                        <td>{{ equipment.eq_instdt.strftime('%Y-%m-%d') if equipment.eq_instdt else 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Manufacture Date:</th>
                                        <td>{{ equipment.eq_mandt.strftime('%Y-%m-%d') if equipment.eq_mandt else 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>End of Life:</th>
                                        <td>
                                            {% if equipment.eq_eoldate %}
                                                {{ equipment.eq_eoldate.strftime('%Y-%m-%d') }}
                                            {% elif equipment.eq_eeoldate %}
                                                {{ equipment.eq_eeoldate.strftime('%Y-%m-%d') }} <span class="text-muted">(estimated)</span>
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% if equipment.eq_retired and equipment.eq_retdate %}
                                    <tr>
                                        <th>Retired Date:</th>
                                        <td>{{ equipment.eq_retdate.strftime('%Y-%m-%d') }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr>
                                        <th>Audit Frequencies:</th>
                                        <td>{{ equipment.eq_auditfreq or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>ACR Site:</th>
                                        <td>{{ equipment.eq_acrsite or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>ACR Unit:</th>
                                        <td>{{ equipment.eq_acrunit or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>ME Facility:</th>
                                        <td>{{ equipment.eq_mefac or 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <th>ME Registration:</th>
                                        <td>{{ equipment.eq_mereg or 'N/A' }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        {% if equipment.facility and equipment.facility.address %}
                        <div class="mt-3">
                            <h6><i class="fas fa-map-marker-alt"></i> Address</h6>
                            <p>{{ equipment.facility.address }}</p>
                        </div>
                        {% endif %}
                        
                        {% if equipment.eq_notes %}
                        <div class="mt-3">
                            <h6><i class="fas fa-sticky-note"></i> Notes</h6>
                            <p>{{ equipment.eq_notes }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Compliance Status -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-check-circle"></i> Compliance Status</h5>
                    </div>
                    <div class="card-body">
                        {% if is_retired %}
                        <div class="card mb-2" style="background-color: #d1ecf1 !important; border-color: #bee5eb !important; color: #212529 !important;">
                            <div class="card-body">
                                <h6 style="color: #212529 !important;"><i class="fas fa-info-circle"></i> Equipment Status</h6>
                                <p class="mb-0" style="color: #212529 !important;">
                                    <strong>Retired Equipment</strong><br>
                                    No further compliance testing required.
                                    {% if equipment.eq_retdate %}
                                    <br><small style="color: #6c757d !important;">Retired: {{ equipment.eq_retdate.strftime('%Y-%m-%d') }}</small>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% else %}
                            {% if next_test %}
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-clock"></i> Next Test Due</h6>
                                <p class="mb-0">
                                    <strong>{{ next_test.get_test_type_display() }}</strong><br>
                                    Due: {{ next_test.next_due_date.strftime('%Y-%m-%d') }}
                                </p>
                            </div>
                            {% endif %}

                            {% if scheduled_tests %}
                                {% for scheduled in scheduled_tests %}
                                <div class="card text-dark mb-2" style="background-color: #d1f2d1 !important; color: #000 !important; cursor: pointer;" ondblclick="window.location.href='{{ url_for('schedule_test_edit', schedule_id=scheduled.schedule_id, **search_params) }}'" title="Double-click to edit">
                                    <div class="card-body py-2">
                                        <h6><i class="fas fa-calendar-check"></i> Scheduled Test</h6>
                                        <p class="mb-0">
                                            <strong>Scheduled for:</strong> {{ scheduled.scheduled_date.strftime('%Y-%m-%d') }}<br>
                                            <small>Set on: {{ scheduled.scheduling_date.strftime('%Y-%m-%d') }}</small>
                                            {% if scheduled.created_by %}
                                                {% if ',' in scheduled.created_by.name %}
                                                    {% set parts = scheduled.created_by.name.split(',') %}
                                                    <br><small>By: {{ parts[1].strip()[0] if parts[1].strip() else '' }}{{ parts[0].strip()[0] if parts[0].strip() else '' }}</small>
                                                {% else %}
                                                    <br><small>By: {{ scheduled.created_by.name[:2].upper() }}</small>
                                                {% endif %}
                                            {% endif %}
                                            {% if scheduled.notes %}
                                            <br><small>{{ scheduled.notes }}</small>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}

                            {% if current_user.can_manage_compliance() %}
                                <div class="text-center">
                                    <a href="{{ url_for('compliance_test_new', eq_id=equipment.eq_id, **request.args) }}"
                                       class="btn btn-warning me-2">
                                        <i class="fas fa-plus"></i> Add New Test
                                    </a>
                                    <a href="{{ url_for('schedule_test_new', eq_id=equipment.eq_id, **request.args) }}"
                                       class="btn btn-success">
                                        <i class="fas fa-calendar-plus"></i> Schedule
                                    </a>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Capital Details -->
                <div class="card mt-4" id="capital-details-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-dollar-sign"></i> Capital Details</h5>
                        {% if current_user.can_manage_equipment() %}
                            <button class="btn btn-sm btn-outline-primary edit-card-btn" data-card="capital-details" title="Edit Capital Details">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            {% if equipment.eq_radcap is not none %}
                            <tr>
                                <th>Radiology Owned:</th>
                                <td>{% if equipment.eq_radcap == 1 %}Yes{% else %}No{% endif %}</td>
                            </tr>
                            {% endif %}
                            {% if equipment.eq_capcat is not none %}
                            <tr>
                                <th>Capital Cost Category:</th>
                                <td>
                                    {% if equipment.eq_capcat == 0 %}N/A
                                    {% elif equipment.eq_capcat == 1 %}Category 1
                                    {% elif equipment.eq_capcat == 2 %}Category 2
                                    {% elif equipment.eq_capcat == 3 %}Category 3
                                    {% else %}{{ equipment.eq_capcat }}{% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if equipment.eq_capcst %}
                            <tr>
                                <th>Capital Cost:</th>
                                <td>${{ "{:,}".format(equipment.eq_capcst * 1000) }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Compliance Tests History -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history"></i> Compliance Tests History</h5>
                {% if not is_retired and current_user.can_manage_compliance() %}
                    <a href="{{ url_for('compliance_test_new', eq_id=equipment.eq_id, **request.args) }}" class="btn btn-warning btn-sm">
                        <i class="fas fa-plus"></i> Add New Test
                    </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if tests.items %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="test_type">
                                        Test Type <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-column="test_date">
                                        Test Date <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-column="report_date">
                                        Report Date <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-column="submission_date">
                                        Submission Date <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-column="performed_by">
                                        Performed By <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-column="reviewed_by">
                                        Reviewing Physicist <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-column="modified_by">
                                        Modified By <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-column="notes">
                                        Notes <i class="fas fa-sort"></i>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test in tests.items %}
                                <tr data-test-type="{{ test.test_type }}"
                                    data-test-date="{{ test.test_date.strftime('%Y-%m-%d') }}"
                                    data-report-date="{{ test.report_date.strftime('%Y-%m-%d') if test.report_date else '' }}"
                                    data-performed-by="{{ test.performed_by.name if test.performed_by else '' }}"
                                    data-reviewed-by="{{ test.reviewed_by.name if test.reviewed_by else '' }}"
                                    data-submission-date="{{ test.submission_date.strftime('%Y-%m-%d') if test.submission_date else '' }}"
                                    data-modified-by="{{ test.modified_by if test.modified_by else '' }}"
                                    data-notes="{{ test.notes if test.notes else '' }}">
                                    <td>{{ test.get_test_type_display() }}</td>
                                    <td>{{ test.test_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ test.report_date.strftime('%Y-%m-%d') if test.report_date else 'N/A' }}</td>
                                    <td>{{ test.submission_date.strftime('%Y-%m-%d') if test.submission_date else 'N/A' }}</td>
                                    <td>{{ test.performed_by.name if test.performed_by else 'N/A' }}</td>
                                    <td>{{ test.reviewed_by.name if test.reviewed_by else 'N/A' }}</td>
                                    <td>
                                        {% if test.modified_by %}
                                            <span class="badge bg-secondary" title="Modified: {{ test.updated_at.strftime('%Y-%m-%d %H:%M') if test.updated_at else 'Unknown' }}">{{ test.modified_by }}</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ test.notes if test.notes else 'N/A' }}</td>
                                    <td style="white-space: nowrap;">
                                        {% if current_user.can_manage_compliance() %}
                                            <a href="{{ url_for('compliance_test_edit', test_id=test.test_id, **search_params) }}"
                                               class="btn btn-sm btn-outline-primary me-1" title="Edit Test">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteComplianceTest({{ test.test_id }}, '{{ test.get_test_type_display() }}', '{{ test.test_date.strftime('%Y-%m-%d') }}')"
                                                    title="Delete Test">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% else %}
                                            <span class="text-muted">View Only</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination for compliance tests -->
                    {% if tests.pages > 1 %}
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted">
                            Showing {{ tests.per_page * (tests.page - 1) + 1 }}-{{ tests.per_page * (tests.page - 1) + tests.items|length }} of {{ tests.total }} tests
                        </div>
                        <nav aria-label="Compliance tests pagination">
                            <ul class="pagination pagination-sm mb-0">
                                {% if tests.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('equipment_detail', eq_id=equipment.eq_id, test_page=tests.prev_num, **search_params) }}">&laquo; Previous</a>
                                    </li>
                                {% endif %}
                                
                                {% for page_num in tests.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != tests.page %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('equipment_detail', eq_id=equipment.eq_id, test_page=page_num, **search_params) }}">{{ page_num }}</a>
                                            </li>
                                        {% else %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page_num }}</span>
                                            </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">â€¦</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if tests.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('equipment_detail', eq_id=equipment.eq_id, test_page=tests.next_num, **search_params) }}">Next &raquo;</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard-list fa-3x text-muted"></i>
                        <h4 class="text-muted mt-3">No compliance tests recorded</h4>
                        <p class="text-muted">
                            {% if current_user.can_manage_compliance() %}
                                <a href="{{ url_for('compliance_test_new', eq_id=equipment.eq_id, **request.args) }}">Add the first compliance test</a> for this equipment.
                            {% else %}
                                No compliance test records are available for this equipment.
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Contact Information -->
        <div class="card mt-4" id="contact-info-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-address-book"></i> Contact Information</h5>
                {% if current_user.can_manage_equipment() %}
                    <button class="btn btn-sm btn-outline-primary edit-card-btn" data-card="contact-info" title="Edit Contact Information">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <h6><i class="fas fa-user"></i> Primary Contact</h6>
                        <div class="border rounded p-3 h-100">
                            {% if equipment.contact %}
                                <div><strong>{{ equipment.contact.name }}</strong></div>
                                {% if equipment.contact.email %}
                                    <div class="mt-1">
                                        <i class="fas fa-envelope text-primary"></i> 
                                        <a href="mailto:{{ equipment.contact.email }}" style="font-family: monospace; font-size: 0.9em; text-decoration: none;">{{ equipment.contact.email }}</a>
                                    </div>
                                {% endif %}
                                {% if equipment.contact.phone %}
                                    <div class="mt-1">
                                        <i class="fas fa-phone text-success"></i> {{ equipment.contact.phone }}
                                    </div>
                                {% endif %}
                                {% if equipment.contact.department %}
                                    <div class="mt-1">
                                        <i class="fas fa-building text-secondary"></i> {{ equipment.contact.department }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-muted"><i class="fas fa-user-slash"></i> No contact assigned</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <h6><i class="fas fa-user-tie"></i> Supervisor</h6>
                        <div class="border rounded p-3 h-100">
                            {% if equipment.supervisor %}
                                <div><strong>{{ equipment.supervisor.name }}</strong></div>
                                {% if equipment.supervisor.email %}
                                    <div class="mt-1">
                                        <i class="fas fa-envelope text-primary"></i> 
                                        <a href="mailto:{{ equipment.supervisor.email }}" style="font-family: monospace; font-size: 0.9em; text-decoration: none;">{{ equipment.supervisor.email }}</a>
                                    </div>
                                {% endif %}
                                {% if equipment.supervisor.phone %}
                                    <div class="mt-1">
                                        <i class="fas fa-phone text-success"></i> {{ equipment.supervisor.phone }}
                                    </div>
                                {% endif %}
                                {% if equipment.supervisor.department %}
                                    <div class="mt-1">
                                        <i class="fas fa-building text-secondary"></i> {{ equipment.supervisor.department }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-muted"><i class="fas fa-user-slash"></i> No supervisor assigned</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <h6><i class="fas fa-user-md"></i> Physician</h6>
                        <div class="border rounded p-3 h-100">
                            {% if equipment.physician %}
                                <div><strong>{{ equipment.physician.name }}</strong></div>
                                {% if equipment.physician.email %}
                                    <div class="mt-1">
                                        <i class="fas fa-envelope text-primary"></i> 
                                        <a href="mailto:{{ equipment.physician.email }}" style="font-family: monospace; font-size: 0.9em; text-decoration: none;">{{ equipment.physician.email }}</a>
                                    </div>
                                {% endif %}
                                {% if equipment.physician.phone %}
                                    <div class="mt-1">
                                        <i class="fas fa-phone text-success"></i> {{ equipment.physician.phone }}
                                    </div>
                                {% endif %}
                                {% if equipment.physician.department %}
                                    <div class="mt-1">
                                        <i class="fas fa-building text-secondary"></i> {{ equipment.physician.department }}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-muted"><i class="fas fa-user-slash"></i> No physician assigned</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global state for card editing
let currentlyEditingCard = null;
let formData = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize card editing
    initCardEditing();

    // Check if we should auto-edit based on URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('edit') === 'equipment_details') {
        const equipmentDetailsBtn = document.querySelector('[data-card="equipment-details"]');
        if (equipmentDetailsBtn) {
            equipmentDetailsBtn.click();
        }
    }

    // Add sorting functionality to compliance tests table
    const sortableHeaders = document.querySelectorAll('.sortable');
    let currentSort = { column: 'test_date', direction: 'desc' }; // Default sort by test date descending
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.column;
            let direction = 'asc';
            
            // Toggle direction if clicking the same column
            if (currentSort.column === column) {
                direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            }
            
            currentSort = { column, direction };
            sortTable(column, direction);
            updateSortIcons(this, direction);
        });
    });
    
    // Set initial sort icon to show current backend sorting (test_date desc)
    const testDateHeader = document.querySelector('[data-column="test_date"]');
    if (testDateHeader) {
        updateSortIcons(testDateHeader, 'desc');
    }
    
    function sortTable(column, direction) {
        const tbody = document.querySelector('.table-striped tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let aValue = a.dataset[column.replace('_', '-')] || '';
            let bValue = b.dataset[column.replace('_', '-')] || '';
            
            // Handle date sorting
            if (column === 'test_date' || column === 'report_date') {
                aValue = new Date(aValue || '1900-01-01');
                bValue = new Date(bValue || '1900-01-01');
            } else {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }
            
            if (direction === 'asc') {
                return aValue > bValue ? 1 : -1;
            } else {
                return aValue > bValue ? -1 : 1;
            }
        });
        
        // Clear and re-append sorted rows
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function updateSortIcons(activeHeader, direction) {
        // Reset all icons
        sortableHeaders.forEach(header => {
            const icon = header.querySelector('i');
            icon.className = 'fas fa-sort';
        });
        
        // Set active icon
        const activeIcon = activeHeader.querySelector('i');
        activeIcon.className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
});

// Card editing functions
function initCardEditing() {
    const editButtons = document.querySelectorAll('.edit-card-btn');
    editButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const cardName = this.dataset.card;
            enterEditMode(cardName);
        });
    });
}

function setupSubclassFilter() {
    const classSelect = document.getElementById('edit-class-id');
    const subclassSelect = document.getElementById('edit-subclass-id');

    if (classSelect && subclassSelect) {
        const currentSubclassId = subclassSelect.value;

        async function updateSubclasses() {
            const selectedClassId = classSelect.value;

            if (!selectedClassId) {
                // If no class selected, show all subclasses
                return;
            }

            const url = `/api/subclasses?class_id=${encodeURIComponent(selectedClassId)}`;

            try {
                const response = await fetch(url);
                const subclasses = await response.json();

                // Save current selection
                const currentValue = subclassSelect.value;

                // Clear existing options
                subclassSelect.innerHTML = '<option value="">Select Subclass</option>';

                // Add new options
                subclasses.forEach(subclass => {
                    const option = document.createElement('option');
                    option.value = subclass.id;
                    option.textContent = subclass.name;

                    // Restore selection if it's still valid for this class
                    if (subclass.id == currentValue) {
                        option.selected = true;
                    }

                    subclassSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading subclasses:', error);
            }
        }

        // Update subclasses when class changes
        classSelect.addEventListener('change', function() {
            updateSubclasses();
        });

        // Initial load - update subclasses for current class selection
        if (classSelect.value) {
            updateSubclasses();
        }
    }
}

async function enterEditMode(cardName) {
    if (currentlyEditingCard) {
        alert('Please save or cancel the current edit before editing another section.');
        return;
    }

    currentlyEditingCard = cardName;

    // Fetch form data if not already loaded
    if (!formData) {
        const eqId = {{ equipment.eq_id }};
        const response = await fetch(`/api/equipment/${eqId}/form-data`);
        formData = await response.json();
    }

    // Lock other edit buttons
    lockOtherCards(cardName);

    // Hide compliance status if editing equipment details
    if (cardName === 'equipment-details') {
        // Find the Compliance Status card in the sidebar (col-md-4)
        const sidebar = document.querySelector('.col-md-4');
        if (sidebar) {
            const complianceCard = sidebar.querySelector('.card:not(#capital-details-card)');
            if (complianceCard) {
                complianceCard.style.display = 'none';
            }
        }
    }

    // Disable compliance test pagination
    const pagination = document.querySelector('.pagination');
    if (pagination) {
        pagination.style.pointerEvents = 'none';
        pagination.style.opacity = '0.5';
    }

    // Replace card content with edit form
    const card = document.getElementById(`${cardName}-card`);
    const cardBody = card.querySelector('.card-body');
    const originalContent = cardBody.innerHTML;

    // Store original content for cancel
    cardBody.dataset.originalContent = originalContent;

    // Generate and inject edit form
    cardBody.innerHTML = generateEditForm(cardName);

    // Setup cascading filter for equipment details card
    if (cardName === 'equipment-details') {
        setupSubclassFilter();
    }

    // Replace edit button with save/cancel buttons
    const editBtn = card.querySelector('.edit-card-btn');
    editBtn.outerHTML = `
        <div>
            <button class="btn btn-sm btn-success me-2" onclick="saveCard('${cardName}')">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-sm btn-secondary" onclick="cancelEdit('${cardName}')">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    `;
}

function generateEditForm(cardName) {
    const eq = formData.equipment;
    const choices = formData.choices;

    if (cardName === 'equipment-details') {
        return generateEquipmentDetailsForm(eq, choices);
    } else if (cardName === 'capital-details') {
        return generateCapitalDetailsForm(eq);
    } else if (cardName === 'contact-info') {
        return generateContactInfoForm(eq, choices);
    }
}

function generateEquipmentDetailsForm(eq, choices) {
    return `
        <form id="edit-equipment-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Equipment ID</label>
                        <input type="text" class="form-control" value="${eq.eq_id}" disabled style="color: #495057;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Equipment Class *</label>
                        <select class="form-control" name="class_id" id="edit-class-id" required>
                            <option value="">Select Class</option>
                            ${choices.classes.map(c => `<option value="${c.id}" ${eq.class_id == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subclass</label>
                        <select class="form-control" name="subclass_id" id="edit-subclass-id">
                            <option value="">Select Subclass</option>
                            ${choices.subclasses.map(s => `<option value="${s.id}" ${eq.subclass_id == s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Manufacturer</label>
                        <select class="form-control" name="manufacturer_id">
                            <option value="">Select Manufacturer</option>
                            ${choices.manufacturers.map(m => `<option value="${m.id}" ${eq.manufacturer_id == m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" name="eq_mod" value="${eq.eq_mod || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Facility</label>
                        <select class="form-control" name="facility_id">
                            <option value="">Select Facility</option>
                            ${choices.facilities.map(f => `<option value="${f.id}" ${eq.facility_id == f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Department</label>
                        <select class="form-control" name="department_id">
                            <option value="">Select Department</option>
                            ${choices.departments.map(d => `<option value="${d.id}" ${eq.department_id == d.id ? 'selected' : ''}>${d.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Room</label>
                        <input type="text" class="form-control" name="eq_rm" value="${eq.eq_rm || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" name="eq_phone" value="${eq.eq_phone || ''}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Asset ID</label>
                        <input type="text" class="form-control" name="eq_assetid" value="${eq.eq_assetid || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Serial Number</label>
                        <input type="text" class="form-control" name="eq_sn" value="${eq.eq_sn || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Manufacturer ID</label>
                        <input type="text" class="form-control" name="eq_manid" value="${eq.eq_manid || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Installation Date</label>
                        <input type="date" class="form-control" name="eq_instdt" value="${eq.eq_instdt || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Manufacture Date</label>
                        <input type="date" class="form-control" name="eq_mandt" value="${eq.eq_mandt || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End of Life Date</label>
                        <input type="date" class="form-control" name="eq_eoldate" value="${eq.eq_eoldate || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Estimated End of Life Date</label>
                        <input type="date" class="form-control" name="eq_eeoldate" value="${eq.eq_eeoldate || ''}">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="eq_retired" ${eq.eq_retired ? 'checked' : ''}>
                            <label class="form-check-label">Retired</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Retirement Date</label>
                        <input type="date" class="form-control" name="eq_retdate" value="${eq.eq_retdate || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Audit Frequencies</label>
                        <div>
                            ${choices.audit_frequencies.map(f => {
                                const frequencies = eq.eq_auditfreq ? eq.eq_auditfreq.split(',').map(x => x.trim()) : [];
                                const isChecked = frequencies.includes(f);
                                return `
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="eq_auditfreq" value="${f}" ${isChecked ? 'checked' : ''} id="freq_${f.replace(/\s+/g, '_')}">
                                        <label class="form-check-label" for="freq_${f.replace(/\s+/g, '_')}">
                                            ${f}
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ACR Site</label>
                        <input type="text" class="form-control" name="eq_acrsite" value="${eq.eq_acrsite || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ACR Unit</label>
                        <input type="text" class="form-control" name="eq_acrunit" value="${eq.eq_acrunit || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ME Facility</label>
                        <input type="text" class="form-control" name="eq_mefac" value="${eq.eq_mefac || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ME Registration</label>
                        <input type="text" class="form-control" name="eq_mereg" value="${eq.eq_mereg || ''}">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea class="form-control" name="eq_notes" rows="3">${eq.eq_notes || ''}</textarea>
            </div>
        </form>
    `;
}

function generateCapitalDetailsForm(eq) {
    return `
        <form id="edit-capital-form">
            <div class="mb-3">
                <label class="form-label">Radiology Owned</label>
                <select class="form-control" name="eq_radcap">
                    <option value="">Select</option>
                    <option value="0" ${eq.eq_radcap === 0 ? 'selected' : ''}>No</option>
                    <option value="1" ${eq.eq_radcap === 1 ? 'selected' : ''}>Yes</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Capital Category</label>
                <select class="form-control" name="eq_capcat">
                    <option value="">Select</option>
                    <option value="0" ${eq.eq_capcat === 0 ? 'selected' : ''}>N/A</option>
                    <option value="1" ${eq.eq_capcat === 1 ? 'selected' : ''}>Category 1</option>
                    <option value="2" ${eq.eq_capcat === 2 ? 'selected' : ''}>Category 2</option>
                    <option value="3" ${eq.eq_capcat === 3 ? 'selected' : ''}>Category 3</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Capital Cost (thousands $)</label>
                <input type="number" class="form-control" name="eq_capcst" value="${eq.eq_capcst || ''}">
            </div>
        </form>
    `;
}

function generateContactInfoForm(eq, choices) {
    return `
        <form id="edit-contact-form">
            <div class="mb-3">
                <label class="form-label">Primary Contact</label>
                <select class="form-control" name="contact_id">
                    <option value="">Select Contact</option>
                    ${choices.contacts.map(p => `<option value="${p.id}" ${eq.contact_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Supervisor</label>
                <select class="form-control" name="supervisor_id">
                    <option value="">Select Supervisor</option>
                    ${choices.supervisors.map(p => `<option value="${p.id}" ${eq.supervisor_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Physician</label>
                <select class="form-control" name="physician_id">
                    <option value="">Select Physician</option>
                    ${choices.physicians.map(p => `<option value="${p.id}" ${eq.physician_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                </select>
            </div>
        </form>
    `;
}

async function saveCard(cardName) {
    const eqId = {{ equipment.eq_id }};
    let formElement, endpoint;

    if (cardName === 'equipment-details') {
        formElement = document.getElementById('edit-equipment-form');
        endpoint = `/api/equipment/${eqId}/update-details`;
    } else if (cardName === 'capital-details') {
        formElement = document.getElementById('edit-capital-form');
        endpoint = `/api/equipment/${eqId}/update-capital`;
    } else if (cardName === 'contact-info') {
        formElement = document.getElementById('edit-contact-form');
        endpoint = `/api/equipment/${eqId}/update-contacts`;
    }

    // Collect form data
    const formDataObj = new FormData(formElement);
    const data = {};

    // Handle checkboxes (audit frequencies) separately
    const auditFreqs = [];
    formDataObj.forEach((value, key) => {
        if (key === 'eq_auditfreq') {
            auditFreqs.push(value);
        } else {
            data[key] = value;
        }
    });

    // Join audit frequencies with comma
    if (auditFreqs.length > 0) {
        data['eq_auditfreq'] = auditFreqs.join(', ');
    } else {
        data['eq_auditfreq'] = '';
    }

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]');

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken ? csrfToken.getAttribute('content') : ''
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            // Reload the page to show updated data
            window.location.reload();
        } else {
            alert('Error saving changes: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving changes. Please try again.');
    }
}

function cancelEdit(cardName) {
    const card = document.getElementById(`${cardName}-card`);
    const cardBody = card.querySelector('.card-body');

    // Restore original content
    cardBody.innerHTML = cardBody.dataset.originalContent;

    // Restore edit button
    const buttonContainer = card.querySelector('.card-header > div');
    buttonContainer.innerHTML = `
        <button class="btn btn-sm btn-outline-primary edit-card-btn" data-card="${cardName}" title="Edit ${cardName.replace('-', ' ')}">
            <i class="fas fa-pencil-alt"></i>
        </button>
    `;

    // Re-attach event listener
    const editBtn = buttonContainer.querySelector('.edit-card-btn');
    editBtn.addEventListener('click', function() {
        enterEditMode(this.dataset.card);
    });

    // Unlock other cards
    unlockAllCards();

    // Show compliance status if it was hidden
    if (cardName === 'equipment-details') {
        const sidebar = document.querySelector('.col-md-4');
        if (sidebar) {
            const complianceCard = sidebar.querySelector('.card:not(#capital-details-card)');
            if (complianceCard) {
                complianceCard.style.display = '';
            }
        }
    }

    // Re-enable pagination
    const pagination = document.querySelector('.pagination');
    if (pagination) {
        pagination.style.pointerEvents = '';
        pagination.style.opacity = '';
    }

    currentlyEditingCard = null;
}

function lockOtherCards(currentCard) {
    const editButtons = document.querySelectorAll('.edit-card-btn');
    editButtons.forEach(btn => {
        if (btn.dataset.card !== currentCard) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        }
    });
}

function unlockAllCards() {
    const editButtons = document.querySelectorAll('.edit-card-btn');
    editButtons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '';
    });
}

// Delete compliance test function
function deleteComplianceTest(testId, testType, testDate) {
    if (confirm(`Are you sure you want to delete the ${testType} test from ${testDate}?\n\nThis action cannot be undone.`)) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/compliance/test/${testId}/delete`;

        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }

        // Preserve filter parameters from current URL
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.forEach((value, key) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        });

        // Submit the form
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}