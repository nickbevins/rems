{% extends "base.html" %}

{% block title %}Equipment List - REMS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-cogs"></i> Equipment List</h1>
            <div>
                {% if current_user.can_manage_equipment() %}
                    <a href="{{ url_for('equipment_new') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Equipment
                    </a>
                {% endif %}
                <a href="{{ url_for('export_equipment', **request.args) }}" class="btn btn-success">
                    <i class="fas fa-download"></i> Export CSV
                </a>
                {% if current_user.can_manage_equipment() %}
                    <a href="{{ url_for('import_data') }}" class="btn btn-info">
                        <i class="fas fa-file-import"></i> Import Data
                    </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" id="filterForm" class="row g-3">
                    <!-- First row: Dropdown filters -->
                    <div class="col-md-3">
                        <label for="eq_class" class="form-label">Equipment Class</label>
                        <select name="eq_class" id="eq_class" class="form-select auto-filter">
                            <option value="">All Classes</option>
                            {% for class_name in classes %}
                                <option value="{{ class_name }}" {% if request.args.get('eq_class') == class_name %}selected{% endif %}>
                                    {{ class_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="eq_subclass" class="form-label">Subclass</label>
                        <select name="eq_subclass" id="eq_subclass" class="form-select auto-filter">
                            <option value="">All Subclasses</option>
                            {% for subclass in subclasses %}
                                <option value="{{ subclass }}" {% if request.args.get('eq_subclass') == subclass %}selected{% endif %}>
                                    {{ subclass }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="eq_manu" class="form-label">Manufacturer</label>
                        <select name="eq_manu" id="eq_manu" class="form-select auto-filter">
                            <option value="">All Manufacturers</option>
                            {% for manufacturer in manufacturers %}
                                <option value="{{ manufacturer }}" {% if request.args.get('eq_manu') == manufacturer %}selected{% endif %}>
                                    {{ manufacturer }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="eq_dept" class="form-label">Department</label>
                        <select name="eq_dept" id="eq_dept" class="form-select auto-filter">
                            <option value="">All Departments</option>
                            {% for department in departments %}
                                <option value="{{ department }}" {% if request.args.get('eq_dept') == department %}selected{% endif %}>
                                    {{ department }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Second row: Search and Facility -->
                    <div class="col-md-6">
                        <label for="search" class="form-label">Search Equipment</label>
                        <input type="text" name="search" id="search" class="form-control" 
                               placeholder="Search by any field... (press Enter)" 
                               value="{{ request.args.get('search', '') }}">
                    </div>
                    <div class="col-md-6">
                        <label for="eq_fac" class="form-label">Facility</label>
                        <select name="eq_fac" id="eq_fac" class="form-select auto-filter">
                            <option value="">All Facilities</option>
                            {% for facility in facilities %}
                                <option value="{{ facility }}" {% if request.args.get('eq_fac') == facility %}selected{% endif %}>
                                    {{ facility }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
                
                <!-- Clear button and options -->
                <div class="row mt-2">
                    <div class="col-6">
                        <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <span class="text-muted small ms-3">{{ equipment.total }} total results</span>
                    </div>
                    <div class="col-6 text-end">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input auto-filter" type="checkbox" name="include_retired" value="true" id="include_retired" form="filterForm"
                                   {% if request.args.get('include_retired') == 'true' %}checked{% endif %}>
                            <label class="form-check-label text-muted small" for="include_retired">
                                Include retired equipment
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Equipment Table -->
        <div class="card">
            <div class="card-body">
                {% if equipment.items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="equipmentTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="eq_class">
                                        Class <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_manu">
                                        Manufacturer <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_mod">
                                        Model <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_dept">
                                        Department <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_rm">
                                        Room <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_fac">
                                        Facility <i class="fas fa-sort"></i>
                                    </th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in equipment.items %}
                                    {% set is_retired = eq.eq_retired or (eq.eq_retdate and eq.eq_retdate <= today) %}
                                <tr {% if is_retired %}class="table-secondary equipment-row"{% else %}class="equipment-row"{% endif %} 
                                    data-eq-id="{{ eq.eq_id }}" style="cursor: pointer;" 
                                    title="Double-click to view details">
                                    <td>
                                        <div class="fw-bold">{{ eq.equipment_class.name if eq.equipment_class else 'N/A' }}</div>
                                        {% if eq.equipment_subclass %}
                                            <div class="text-muted">{{ eq.equipment_subclass.name }}</div>
                                        {% endif %}
                                    </td>
                                    <td>{{ eq.manufacturer.name if eq.manufacturer else 'N/A' }}</td>
                                    <td>{{ eq.eq_mod or 'N/A' }}</td>
                                    <td>{{ eq.department.name if eq.department else 'N/A' }}</td>
                                    <td>{{ eq.eq_rm or 'N/A' }}</td>
                                    <td>{{ eq.facility.name if eq.facility else 'N/A' }}</td>
                                    <td>
                                        {% if is_retired %}
                                            <span class="badge bg-danger">Retired</span>
                                            {% if eq.eq_retdate %}
                                                <br><small class="text-secondary">{{ eq.eq_retdate.strftime('%Y-%m-%d') }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td style="white-space: nowrap;">
                                        <a href="{{ url_for('equipment_detail', eq_id=eq.eq_id, **request.args) }}" class="btn btn-sm btn-outline-info btn-icon" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if current_user.can_manage_equipment() %}
                                            <a href="{{ url_for('equipment_edit', eq_id=eq.eq_id) }}" class="btn btn-sm btn-outline-primary btn-icon" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        {% endif %}
                                        {% if current_user.can_manage_compliance() %}
                                            <a href="{{ url_for('compliance_test_new', eq_id=eq.eq_id) }}" class="btn btn-sm btn-outline-warning btn-icon" title="Add Test">
                                                <i class="fas fa-check-circle"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if equipment.pages > 1 %}
                    <nav aria-label="Equipment pagination">
                        <ul class="pagination justify-content-center">
                            {% if equipment.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('equipment_list', page=equipment.prev_num, search=request.args.get('search'), eq_class=request.args.get('eq_class'), eq_subclass=request.args.get('eq_subclass'), eq_manu=request.args.get('eq_manu'), eq_dept=request.args.get('eq_dept'), eq_fac=request.args.get('eq_fac'), include_retired=request.args.get('include_retired'), sort=request.args.get('sort'), order=request.args.get('order')) }}">Previous</a>
                                </li>
                            {% endif %}
                            
                            {% for page_num in equipment.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != equipment.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('equipment_list', page=page_num, search=request.args.get('search'), eq_class=request.args.get('eq_class'), eq_subclass=request.args.get('eq_subclass'), eq_manu=request.args.get('eq_manu'), eq_dept=request.args.get('eq_dept'), eq_fac=request.args.get('eq_fac'), include_retired=request.args.get('include_retired'), sort=request.args.get('sort'), order=request.args.get('order')) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if equipment.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('equipment_list', page=equipment.next_num, search=request.args.get('search'), eq_class=request.args.get('eq_class'), eq_subclass=request.args.get('eq_subclass'), eq_manu=request.args.get('eq_manu'), eq_dept=request.args.get('eq_dept'), eq_fac=request.args.get('eq_fac'), include_retired=request.args.get('include_retired'), sort=request.args.get('sort'), order=request.args.get('order')) }}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-search fa-3x text-muted"></i>
                        <h4 class="text-muted mt-3">No equipment found</h4>
                        <p class="text-muted">Try adjusting your search filters{% if current_user.can_manage_equipment() %} or <a href="{{ url_for('equipment_new') }}">add new equipment</a>{% endif %}.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

<style>
.sortable {
    cursor: pointer;
    user-select: none;
}
.sortable:hover {
    background-color: #f8f9fa;
    color: #212529;
}
.sortable i {
    margin-left: 5px;
    opacity: 0.3;
}
.sortable.asc i:before {
    content: "\f0de";
    opacity: 1;
}
.sortable.desc i:before {
    content: "\f0dd";
    opacity: 1;
}
.equipment-row {
    cursor: pointer;
}
.btn-icon {
    padding: 0.25rem 0.5rem !important;
    font-size: 0.75rem;
    line-height: 1;
    min-width: 2rem;
    height: auto !important;
}
/* Normalize table row heights */
#equipmentTable tbody tr {
    height: 60px;
}
#equipmentTable tbody td {
    vertical-align: middle;
}
/* Add Test button hover behavior */
.btn-outline-warning.btn-icon:hover {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #212529 !important;
}
/* Additional styling handled in global CSS */
</style>

{% block scripts %}
<script>
    // Auto-filter functionality
    document.addEventListener('DOMContentLoaded', function() {
        const autoFilterElements = document.querySelectorAll('.auto-filter');
        const searchInput = document.getElementById('search');
        
        autoFilterElements.forEach(element => {
            element.addEventListener('change', function() {
                document.getElementById('filterForm').submit();
            });
        });
        
        // Handle search input with Enter key
        if (searchInput) {
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('filterForm').submit();
                }
            });
        }
        
        // Double-click to view details
        const equipmentRows = document.querySelectorAll('.equipment-row');
        equipmentRows.forEach(row => {
            row.addEventListener('dblclick', function(e) {
                // Don't trigger if clicking on action buttons
                if (e.target.closest('.btn-group')) return;
                
                const eqId = this.getAttribute('data-eq-id');
                const currentParams = new URLSearchParams(window.location.search);
                window.location.href = `/equipment/${eqId}?${currentParams.toString()}`;
            });
        });
        
        // Column sorting functionality
        const sortableHeaders = document.querySelectorAll('.sortable');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortField = this.getAttribute('data-sort');
                const currentSort = new URLSearchParams(window.location.search).get('sort');
                const currentOrder = new URLSearchParams(window.location.search).get('order');
                
                let newOrder = 'asc';
                if (currentSort === sortField && currentOrder === 'asc') {
                    newOrder = 'desc';
                }
                
                // Update URL with sort parameters
                const url = new URL(window.location);
                url.searchParams.set('sort', sortField);
                url.searchParams.set('order', newOrder);
                url.searchParams.set('page', '1'); // Reset to first page
                
                window.location.href = url.toString();
            });
        });
        
        // Update sort indicators
        const currentSort = new URLSearchParams(window.location.search).get('sort');
        const currentOrder = new URLSearchParams(window.location.search).get('order');
        
        if (currentSort) {
            const activeHeader = document.querySelector(`[data-sort="${currentSort}"]`);
            if (activeHeader) {
                const icon = activeHeader.querySelector('i');
                if (currentOrder === 'asc') {
                    icon.className = 'fas fa-sort-up';
                } else {
                    icon.className = 'fas fa-sort-down';
                }
            }
        }
    });
    
    // Clear all filters
    function clearFilters() {
        const form = document.getElementById('filterForm');
        const inputs = form.querySelectorAll('input, select');
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
        
        // Also clear URL parameters
        window.location.href = window.location.pathname;
    }

    // Cascading filter: Update subclasses when class changes
    document.addEventListener('DOMContentLoaded', function() {
        const classSelect = document.getElementById('eq_class');
        const subclassSelect = document.getElementById('eq_subclass');
        const currentSubclass = '{{ request.args.get("eq_subclass", "") }}';
        
        function updateSubclasses() {
            const selectedClass = classSelect.value;
            const url = selectedClass ? '/api/subclasses?eq_class=' + encodeURIComponent(selectedClass) : '/api/subclasses';
            
            fetch(url)
                .then(response => response.json())
                .then(subclasses => {
                    // Clear existing options
                    subclassSelect.innerHTML = '<option value="">All Subclasses</option>';
                    
                    // Add new options
                    subclasses.forEach(subclass => {
                        const option = document.createElement('option');
                        option.value = subclass;
                        option.textContent = subclass;
                        
                        // Maintain selection if it's still valid
                        if (subclass === currentSubclass) {
                            option.selected = true;
                        }
                        
                        subclassSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading subclasses:', error);
                });
        }
        
        // Update subclasses when class changes
        classSelect.addEventListener('change', function() {
            updateSubclasses();
            // Clear subclass selection when class changes
            subclassSelect.value = '';
        });
        
        // Initial load - update subclasses for current class selection
        if (classSelect.value) {
            updateSubclasses();
        }
    });
</script>
{% endblock %}