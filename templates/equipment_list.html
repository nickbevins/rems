{% extends "base.html" %}

{% block title %}Equipment List - REMS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-cogs"></i> Equipment List</h1>
            <div>
                {% if current_user.can_manage_equipment() %}
                    <a href="{{ url_for('equipment_new') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Equipment
                    </a>
                {% endif %}
                <a href="{{ url_for('export_equipment', **request.args) }}" class="btn btn-success">
                    <i class="fas fa-download"></i> Export CSV
                </a>
                {% if current_user.can_manage_equipment() %}
                    <a href="{{ url_for('import_data') }}" class="btn btn-info">
                        <i class="fas fa-file-import"></i> Import Data
                    </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" id="filterForm" class="row g-3">
                    <!-- First row: Dropdown filters -->
                    <div class="col-md-3">
                        <label for="eq_class" class="form-label">Equipment Class</label>
                        <select name="eq_class" id="eq_class" class="form-select auto-filter">
                            <option value="">All Classes</option>
                            {% for class_name in classes %}
                                <option value="{{ class_name }}" {% if request.args.get('eq_class') == class_name %}selected{% endif %}>
                                    {{ class_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="eq_subclass" class="form-label">Subclass</label>
                        <select name="eq_subclass" id="eq_subclass" class="form-select auto-filter">
                            <option value="">All Subclasses</option>
                            {% for subclass in subclasses %}
                                <option value="{{ subclass }}" {% if request.args.get('eq_subclass') == subclass %}selected{% endif %}>
                                    {{ subclass }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="eq_manu" class="form-label">Manufacturer</label>
                        <select name="eq_manu" id="eq_manu" class="form-select auto-filter">
                            <option value="">All Manufacturers</option>
                            {% for manufacturer in manufacturers %}
                                <option value="{{ manufacturer }}" {% if request.args.get('eq_manu') == manufacturer %}selected{% endif %}>
                                    {{ manufacturer }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="eq_dept" class="form-label">Department</label>
                        <select name="eq_dept" id="eq_dept" class="form-select auto-filter">
                            <option value="">All Departments</option>
                            {% for department in departments %}
                                <option value="{{ department }}" {% if request.args.get('eq_dept') == department %}selected{% endif %}>
                                    {{ department }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Second row: Search and Facility -->
                    <div class="col-md-6">
                        <label for="search" class="form-label">Search Equipment</label>
                        <input type="text" name="search" id="search" class="form-control" 
                               placeholder="Search by any field... (press Enter)" 
                               value="{{ request.args.get('search', '') }}">
                    </div>
                    <div class="col-md-6">
                        <label for="eq_fac" class="form-label">Facility</label>
                        <select name="eq_fac" id="eq_fac" class="form-select auto-filter">
                            <option value="">All Facilities</option>
                            {% for facility in facilities %}
                                <option value="{{ facility }}" {% if request.args.get('eq_fac') == facility %}selected{% endif %}>
                                    {{ facility }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
                
                <!-- Clear button and options -->
                <div class="row mt-2">
                    <div class="col-6">
                        <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <span class="text-muted small ms-3">{{ equipment.total }} total results</span>
                    </div>
                    <div class="col-6 text-end">
                        <div class="d-flex align-items-center justify-content-end gap-3">
                            <div class="form-check form-check-inline mb-0">
                                <input class="form-check-input auto-filter" type="checkbox" name="include_retired" value="true" id="include_retired" form="filterForm"
                                       {% if request.args.get('include_retired') == 'true' %}checked{% endif %}>
                                <label class="form-check-label text-muted small" for="include_retired">
                                    Include retired equipment
                                </label>
                            </div>
                            <div class="d-flex align-items-center">
                                <label for="per_page" class="form-label text-muted small mb-0 me-2">Show:</label>
                                <select name="per_page" id="per_page" class="form-select form-select-sm auto-filter" style="width: auto;" form="filterForm">
                                    <option value="25" {% if request.args.get('per_page', '25') == '25' %}selected{% endif %}>25</option>
                                    <option value="50" {% if request.args.get('per_page') == '50' %}selected{% endif %}>50</option>
                                    <option value="100" {% if request.args.get('per_page') == '100' %}selected{% endif %}>100</option>
                                    <option value="200" {% if request.args.get('per_page') == '200' %}selected{% endif %}>200</option>
                                </select>
                            </div>
                            <div class="d-flex gap-2">
                                {% if request.args.get('show_all') == 'true' %}
                                    <a href="{{ url_for('equipment_list', **request.args) | replace('&show_all=true', '') | replace('show_all=true&', '') | replace('show_all=true', '') }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-list"></i> Paginate
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('equipment_list', show_all='true', **request.args) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> Show All
                                    </a>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="resetColumnOrder()" title="Reset column order to default">
                                    <i class="fas fa-undo"></i> Reset Columns
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Equipment Table -->
        <div class="card">
            <div class="card-body">
                {% if equipment.items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="equipmentTable">
                            <thead>
                                <tr id="equipmentTableHeader">
                                    <th class="sortable" data-sort="eq_class">
                                        Class <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_manu">
                                        Manufacturer <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_dept">
                                        Department <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_rm">
                                        Room <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_fac">
                                        Facility <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="eq_mereg">
                                        ME Registration <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-sort="days_until_due">
                                        Days Until Due <i class="fas fa-sort"></i>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in equipment.items %}
                                    {% set is_retired = eq.eq_retired or (eq.eq_retdate and eq.eq_retdate <= today) %}
                                <tr {% if is_retired %}class="table-secondary equipment-row"{% else %}class="equipment-row"{% endif %} 
                                    data-eq-id="{{ eq.eq_id }}" style="cursor: pointer;" 
                                    title="Double-click to view details">
                                    <td>
                                        <div>{{ eq.equipment_class.name if eq.equipment_class else 'N/A' }}</div>
                                        {% if eq.equipment_subclass %}
                                            <div class="text-muted">{{ eq.equipment_subclass.name }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>{{ eq.manufacturer.name if eq.manufacturer else 'N/A' }}</div>
                                        {% if eq.eq_mod %}
                                            <div class="text-muted">{{ eq.eq_mod }}</div>
                                        {% endif %}
                                    </td>
                                    <td>{{ eq.department.name if eq.department else 'N/A' }}</td>
                                    <td>{{ eq.eq_rm or 'N/A' }}</td>
                                    <td>{{ eq.facility.name if eq.facility else 'N/A' }}</td>
                                    <td>
                                        <div>{{ eq.eq_mereg or 'N/A' }}</div>
                                        {% if eq.eq_mefac %}
                                            <div class="text-muted">{{ eq.eq_mefac }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if is_retired %}
                                            <span class="badge bg-danger">Retired</span>
                                            {% if eq.eq_retdate %}
                                                <br><small class="text-secondary">{{ eq.eq_retdate.strftime('%Y-%m-%d') }}</small>
                                            {% endif %}
                                        {% else %}
                                            {% set due_date = eq.get_next_due_date() %}
                                            {% if due_date %}
                                                {% set days_until = (due_date - today).days %}
                                                {% if days_until < 0 %}
                                                    <span class="badge bg-danger">{{ days_until|abs }} days overdue</span>
                                                {% elif days_until <= 7 %}
                                                    <span class="badge bg-danger">{{ days_until }} days</span>
                                                {% elif days_until <= 30 %}
                                                    <span class="badge bg-warning text-dark">{{ days_until }} days</span>
                                                {% elif days_until <= 90 %}
                                                    <span class="badge bg-info text-dark">{{ days_until }} days</span>
                                                {% else %}
                                                    <span class="badge bg-success">{{ days_until }} days</span>
                                                {% endif %}
                                            {% else %}
                                                {% if eq.eq_auditfreq %}
                                                    <span class="badge bg-secondary">No tests yet</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">No frequency</span>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td style="white-space: nowrap;">
                                        <a href="{{ url_for('equipment_detail', eq_id=eq.eq_id, **request.args) }}" class="btn btn-sm btn-outline-info btn-icon" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if current_user.can_manage_equipment() %}
                                            <a href="{{ url_for('equipment_edit', eq_id=eq.eq_id) }}" class="btn btn-sm btn-outline-primary btn-icon" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        {% endif %}
                                        {% if current_user.can_manage_compliance() %}
                                            <a href="{{ url_for('compliance_test_new', eq_id=eq.eq_id) }}" class="btn btn-sm btn-outline-warning btn-icon" title="Add Test">
                                                <i class="fas fa-check-circle"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    
                    {% if request.args.get('show_all') == 'true' %}
                    <div class="text-center text-muted mt-3">
                        <small>Showing all {{ equipment.total }} items</small>
                    </div>
                    {% endif %}
                    
                    <!-- Bottom pagination controls -->
                    <div class="row mt-3 align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center">
                                    <label for="per_page_bottom" class="form-label text-muted small mb-0 me-2">Show:</label>
                                    <select name="per_page" id="per_page_bottom" class="form-select form-select-sm auto-filter" style="width: auto;" form="filterForm">
                                        <option value="25" {% if request.args.get('per_page', '25') == '25' %}selected{% endif %}>25</option>
                                        <option value="50" {% if request.args.get('per_page') == '50' %}selected{% endif %}>50</option>
                                        <option value="100" {% if request.args.get('per_page') == '100' %}selected{% endif %}>100</option>
                                        <option value="200" {% if request.args.get('per_page') == '200' %}selected{% endif %}>200</option>
                                    </select>
                                </div>
                                <div class="d-flex gap-2">
                                    {% if request.args.get('show_all') == 'true' %}
                                        <a href="{{ url_for('equipment_list', **request.args) | replace('&show_all=true', '') | replace('show_all=true&', '') | replace('show_all=true', '') }}" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-list"></i> Paginate
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('equipment_list', show_all='true', **request.args) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> Show All
                                        </a>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="resetColumnOrder()" title="Reset column order to default">
                                        <i class="fas fa-undo"></i> Reset Columns
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Bottom Pagination -->
                            {% if equipment.pages > 1 and request.args.get('show_all') != 'true' %}
                            <nav aria-label="Equipment pagination bottom">
                                <ul class="pagination justify-content-end mb-0">
                                    {% if equipment.has_prev %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('equipment_list', page=equipment.prev_num, search=request.args.get('search'), eq_class=request.args.get('eq_class'), eq_subclass=request.args.get('eq_subclass'), eq_manu=request.args.get('eq_manu'), eq_dept=request.args.get('eq_dept'), eq_fac=request.args.get('eq_fac'), include_retired=request.args.get('include_retired'), sort=request.args.get('sort'), order=request.args.get('order'), per_page=request.args.get('per_page')) }}">Previous</a>
                                        </li>
                                    {% endif %}
                                    
                                    {% for page_num in equipment.iter_pages() %}
                                        {% if page_num %}
                                            {% if page_num != equipment.page %}
                                                <li class="page-item">
                                                    <a class="page-link" href="{{ url_for('equipment_list', page=page_num, search=request.args.get('search'), eq_class=request.args.get('eq_class'), eq_subclass=request.args.get('eq_subclass'), eq_manu=request.args.get('eq_manu'), eq_dept=request.args.get('eq_dept'), eq_fac=request.args.get('eq_fac'), include_retired=request.args.get('include_retired'), sort=request.args.get('sort'), order=request.args.get('order'), per_page=request.args.get('per_page')) }}">{{ page_num }}</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ page_num }}</span>
                                                </li>
                                            {% endif %}
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if equipment.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('equipment_list', page=equipment.next_num, search=request.args.get('search'), eq_class=request.args.get('eq_class'), eq_subclass=request.args.get('eq_subclass'), eq_manu=request.args.get('eq_manu'), eq_dept=request.args.get('eq_dept'), eq_fac=request.args.get('eq_fac'), include_retired=request.args.get('include_retired'), sort=request.args.get('sort'), order=request.args.get('order'), per_page=request.args.get('per_page')) }}">Next</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-search fa-3x text-muted"></i>
                        <h4 class="text-muted mt-3">No equipment found</h4>
                        <p class="text-muted">Try adjusting your search filters{% if current_user.can_manage_equipment() %} or <a href="{{ url_for('equipment_new') }}">add new equipment</a>{% endif %}.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

<style>
.sortable {
    cursor: pointer;
    user-select: none;
}
.sortable:hover {
    background-color: #f8f9fa;
    color: #212529;
}
.sortable i {
    margin-left: 5px;
    opacity: 0.3;
}
.sortable.asc i:before {
    content: "\f0de";
    opacity: 1;
}
.sortable.desc i:before {
    content: "\f0dd";
    opacity: 1;
}
.equipment-row {
    cursor: pointer;
}
.btn-icon {
    padding: 0.25rem 0.5rem !important;
    font-size: 0.75rem;
    line-height: 1;
    min-width: 2rem;
    height: auto !important;
}
/* Normalize table row heights */
#equipmentTable tbody tr {
    height: 60px;
}
#equipmentTable tbody td {
    vertical-align: middle;
}
/* Add Test button hover behavior */
.btn-outline-warning.btn-icon:hover {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #212529 !important;
}
/* Additional styling handled in global CSS */
</style>

{% block scripts %}
<script>
    // Auto-filter functionality
    document.addEventListener('DOMContentLoaded', function() {
        const autoFilterElements = document.querySelectorAll('.auto-filter');
        const searchInput = document.getElementById('search');
        
        autoFilterElements.forEach(element => {
            element.addEventListener('change', function() {
                document.getElementById('filterForm').submit();
            });
        });
        
        // Handle search input with Enter key
        if (searchInput) {
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('filterForm').submit();
                }
            });
        }
        
        // Double-click to view details
        const equipmentRows = document.querySelectorAll('.equipment-row');
        equipmentRows.forEach(row => {
            row.addEventListener('dblclick', function(e) {
                // Don't trigger if clicking on action buttons
                if (e.target.closest('.btn-group')) return;
                
                const eqId = this.getAttribute('data-eq-id');
                const currentParams = new URLSearchParams(window.location.search);
                window.location.href = `/equipment/${eqId}?${currentParams.toString()}`;
            });
        });
        
        // Multi-level column sorting functionality
        let sortStack = [];
        const MAX_SORT_LEVELS = 3;
        
        // Initialize sort stack from URL
        const currentSort = new URLSearchParams(window.location.search).get('sort');
        const currentOrder = new URLSearchParams(window.location.search).get('order');
        
        if (currentSort && currentOrder) {
            const sortFields = currentSort.split(',');
            const sortOrders = currentOrder.split(',');
            
            sortFields.forEach((field, index) => {
                sortStack.push({
                    field: field,
                    order: sortOrders[index] || 'asc'
                });
            });
        }
        
        const sortableHeaders = document.querySelectorAll('.sortable');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortField = this.getAttribute('data-sort');
                
                // Check if this field is already in the sort stack
                const existingIndex = sortStack.findIndex(sort => sort.field === sortField);
                
                if (existingIndex !== -1) {
                    // Field exists - toggle its order
                    if (sortStack[existingIndex].order === 'asc') {
                        sortStack[existingIndex].order = 'desc';
                    } else {
                        // Remove from stack if clicking desc again
                        sortStack.splice(existingIndex, 1);
                    }
                } else {
                    // New field - add to top of stack
                    sortStack.unshift({ field: sortField, order: 'asc' });
                    
                    // Limit to MAX_SORT_LEVELS
                    if (sortStack.length > MAX_SORT_LEVELS) {
                        sortStack = sortStack.slice(0, MAX_SORT_LEVELS);
                    }
                }
                
                // Update URL and reload
                applySortStack();
            });
        });
        
        function applySortStack() {
            const url = new URL(window.location);
            
            if (sortStack.length === 0) {
                url.searchParams.delete('sort');
                url.searchParams.delete('order');
            } else {
                const sortFields = sortStack.map(sort => sort.field).join(',');
                const sortOrders = sortStack.map(sort => sort.order).join(',');
                
                url.searchParams.set('sort', sortFields);
                url.searchParams.set('order', sortOrders);
            }
            
            url.searchParams.set('page', '1'); // Reset to first page
            window.location.href = url.toString();
        }
        
        // Update sort indicators to show multi-level sorting
        function updateSortIndicators() {
            // Reset all icons
            sortableHeaders.forEach(header => {
                const icon = header.querySelector('i');
                icon.className = 'fas fa-sort';
                
                // Remove any existing sort level indicators
                const existingBadge = header.querySelector('.sort-level-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
            });
            
            // Set active icons for sorted columns
            sortStack.forEach((sort, index) => {
                const activeHeader = document.querySelector(`[data-sort="${sort.field}"]`);
                if (activeHeader) {
                    const icon = activeHeader.querySelector('i');
                    
                    // Set sort direction icon
                    if (sort.order === 'asc') {
                        icon.className = 'fas fa-sort-up';
                    } else {
                        icon.className = 'fas fa-sort-down';
                    }
                    
                    // Add sort level indicator (1, 2, 3)
                    if (sortStack.length > 1) {
                        const badge = document.createElement('span');
                        badge.className = 'sort-level-badge badge bg-primary ms-1';
                        badge.textContent = index + 1;
                        badge.style.fontSize = '10px';
                        badge.title = `Sort level ${index + 1}`;
                        activeHeader.appendChild(badge);
                    }
                }
            });
        }
        
        // Initial sort indicators update
        updateSortIndicators();
    });
    
    // Clear all filters
    function clearFilters() {
        const form = document.getElementById('filterForm');
        const inputs = form.querySelectorAll('input, select');
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
        
        // Also clear URL parameters
        window.location.href = window.location.pathname;
    }

    // Cascading filter: Update subclasses when class changes
    document.addEventListener('DOMContentLoaded', function() {
        const classSelect = document.getElementById('eq_class');
        const subclassSelect = document.getElementById('eq_subclass');
        const currentSubclass = '{{ request.args.get("eq_subclass", "") }}';
        
        function updateSubclasses() {
            const selectedClass = classSelect.value;
            const url = selectedClass ? '/api/subclasses?eq_class=' + encodeURIComponent(selectedClass) : '/api/subclasses';
            
            fetch(url)
                .then(response => response.json())
                .then(subclasses => {
                    // Clear existing options
                    subclassSelect.innerHTML = '<option value="">All Subclasses</option>';
                    
                    // Add new options
                    subclasses.forEach(subclass => {
                        const option = document.createElement('option');
                        option.value = subclass;
                        option.textContent = subclass;
                        
                        // Maintain selection if it's still valid
                        if (subclass === currentSubclass) {
                            option.selected = true;
                        }
                        
                        subclassSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading subclasses:', error);
                });
        }
        
        // Update subclasses when class changes
        classSelect.addEventListener('change', function() {
            updateSubclasses();
            // Clear subclass selection when class changes
            subclassSelect.value = '';
        });
        
        // Initial load - update subclasses for current class selection
        if (classSelect.value) {
            updateSubclasses();
        }
    });

    // Column Reordering Functionality
    class ColumnReorderManager {
        constructor(tableId, storageKey) {
            this.table = document.getElementById(tableId);
            this.storageKey = storageKey;
            this.headerRow = document.getElementById(tableId + 'Header');
            this.init();
        }

        init() {
            if (!this.table || !this.headerRow) return;
            
            // Load saved column order
            this.loadColumnOrder();
            
            // Make header row sortable
            this.sortable = Sortable.create(this.headerRow, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: (evt) => {
                    this.reorderTableColumns(evt.oldIndex, evt.newIndex);
                    this.saveColumnOrder();
                }
            });

            // Add visual indicators
            this.addDragIndicators();
        }

        addDragIndicators() {
            const headers = this.headerRow.querySelectorAll('th');
            headers.forEach(header => {
                if (!header.innerHTML.includes('Actions')) { // Don't make Actions column draggable
                    header.style.cursor = 'move';
                    header.title = header.title || header.textContent.trim() + ' - Drag to reorder columns';
                    header.classList.add('draggable-header');
                }
            });
        }

        reorderTableColumns(oldIndex, newIndex) {
            // Reorder all table rows to match header
            const tbody = this.table.querySelector('tbody');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = Array.from(row.children);
                const cellToMove = cells[oldIndex];
                
                if (newIndex >= cells.length) {
                    row.appendChild(cellToMove);
                } else {
                    row.insertBefore(cellToMove, cells[newIndex]);
                }
            });
        }

        saveColumnOrder() {
            const headers = Array.from(this.headerRow.children);
            const order = headers.map(th => {
                // Extract column identifier from sortable data attribute or text
                return th.getAttribute('data-sort') || th.textContent.trim().toLowerCase().replace(/\s+/g, '_');
            });
            
            localStorage.setItem(this.storageKey, JSON.stringify(order));
        }

        loadColumnOrder() {
            const savedOrder = localStorage.getItem(this.storageKey);
            if (!savedOrder) return;

            try {
                const order = JSON.parse(savedOrder);
                this.applyColumnOrder(order);
            } catch (e) {
                console.warn('Failed to load column order:', e);
            }
        }

        applyColumnOrder(order) {
            const headers = Array.from(this.headerRow.children);
            const tbody = this.table.querySelector('tbody');
            
            // Create a mapping of current positions
            const currentOrder = headers.map(th => 
                th.getAttribute('data-sort') || th.textContent.trim().toLowerCase().replace(/\s+/g, '_')
            );

            // Reorder headers
            order.forEach((colId, newIndex) => {
                const currentIndex = currentOrder.indexOf(colId);
                if (currentIndex !== -1 && currentIndex !== newIndex) {
                    const headerToMove = headers[currentIndex];
                    
                    // Move header
                    if (newIndex >= this.headerRow.children.length) {
                        this.headerRow.appendChild(headerToMove);
                    } else {
                        this.headerRow.insertBefore(headerToMove, this.headerRow.children[newIndex]);
                    }

                    // Move corresponding cells in all body rows
                    if (tbody) {
                        const rows = tbody.querySelectorAll('tr');
                        rows.forEach(row => {
                            const cells = Array.from(row.children);
                            const cellToMove = cells[currentIndex];
                            
                            if (newIndex >= cells.length) {
                                row.appendChild(cellToMove);
                            } else {
                                row.insertBefore(cellToMove, cells[newIndex]);
                            }
                        });
                    }
                }
            });
        }

        resetColumnOrder() {
            localStorage.removeItem(this.storageKey);
            location.reload();
        }
    }

    // Initialize column reordering for equipment table
    document.addEventListener('DOMContentLoaded', function() {
        const equipmentTable = document.getElementById('equipmentTable');
        if (equipmentTable) {
            window.equipmentColumnManager = new ColumnReorderManager('equipmentTable', 'equipment_list_column_order');
        }
    });

    // Global function for reset button
    function resetColumnOrder() {
        if (window.equipmentColumnManager && confirm('Reset column order to default? This will reload the page.')) {
            window.equipmentColumnManager.resetColumnOrder();
        }
    }
</script>

<!-- Add CSS for drag indicators -->
<style>
.draggable-header {
    position: relative;
}

.draggable-header:before {
    content: '⋮⋮';
    position: absolute;
    left: 2px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 12px;
    opacity: 0.6;
    font-weight: bold;
    letter-spacing: -2px;
}

.sortable-ghost {
    opacity: 0.5;
    background: #f8f9fa !important;
}

.sortable-chosen {
    background: #e9ecef !important;
}

.sortable-drag {
    background: #dee2e6 !important;
    transform: rotate(2deg);
}

.draggable-header:hover:before {
    opacity: 1;
    color: #495057;
}
</style>
{% endblock %}